name: Audio Devocional
on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install SDK
        run: npm install @google/genai

      - name: Generate Audio
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          cat << 'EOF' > generator.mjs
          import { GoogleGenAI } from '@google/genai';
          import fs from 'fs';

          async function start() {
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            const date = new Date().toISOString().split('T')[0];
            
            const gistUrl = 'https://gist.githubusercontent.com/mickrds/b34732e31123be1e934e6bb0ffd0a0ef/raw/devocionais.json';
            const response = await fetch(gistUrl);
            const devocionais = await response.json();
            const hoje = devocionais[date];

            if (!hoje) {
              console.log('Sem devocional para hoje.');
              return;
            }

            const texto = `${hoje.title}. ${hoje.verseText}. ${hoje.content}`.replace(/\n/g, ' ');
            
            const result = await ai.models.generateContent({
              model: 'gemini-2.5-flash-preview-tts',
              contents: [{ parts: [{ text: texto }] }],
              config: { 
                responseModalities: ['AUDIO'],
                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: 'Kore' } } }
              }
            });

            const audioPart = result.candidates[0].content.parts.find(p => p.inlineData);
            if (audioPart) {
              if (!fs.existsSync('audios')) fs.mkdirSync('audios');
              fs.writeFileSync(`audios/${date}.mp3`, Buffer.from(audioPart.inlineData.data, 'base64'));
              console.log('√Åudio salvo com sucesso.');
            }
          }
          start();
          EOF
          node generator.mjs

      - name: Save to Repo
        run: |
          git config --global user.name 'Devocional Bot'
          git config --global user.email 'bot@luzdiaria.com'
          mkdir -p audios
          git add audios/
          git commit -m "üéôÔ∏è Novo √°udio: $(date +%F)" || echo "Sem mudan√ßas"
          git push
